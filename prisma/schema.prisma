// ============================================
// Bible Palace â€” Prisma Schema
// Railway MySQL
// ============================================

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì„±ê²½ ë°ì´í„° ëª¨ë¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ì„±ê²½ ì±… (66ê¶Œ) â”€â”€â”€
model Book {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(50)  // í•œê¸€ ì´ë¦„: "ì°½ì„¸ê¸°"
  nameEn        String    @map("name_en") @db.VarChar(50)  // English: "Genesis"
  abbreviation  String    @db.VarChar(10)  // ì•½ì–´: "ì°½", "Gen"
  testament     Testament // êµ¬ì•½/ì‹ ì•½
  orderNum      Int       @map("order_num")  // ìˆœì„œ 1~66
  chapterCount  Int       @map("chapter_count")
  chapters      Chapter[]
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("books")
}

// â”€â”€â”€ ì¥ â”€â”€â”€
model Chapter {
  id          Int      @id @default(autoincrement())
  bookId      Int      @map("book_id")
  chapterNum  Int      @map("chapter_num")
  book        Book     @relation(fields: [bookId], references: [id])
  verses      Verse[]
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([bookId, chapterNum])
  @@index([bookId])
  @@map("chapters")
}

// â”€â”€â”€ ì ˆ â”€â”€â”€
model Verse {
  id           Int           @id @default(autoincrement())
  chapterId    Int           @map("chapter_id")
  verseNum     Int           @map("verse_num")
  text         String        @db.Text
  textEn       String?       @map("text_en") @db.Text
  chapter      Chapter       @relation(fields: [chapterId], references: [id])
  bookmarks    Bookmark[]
  highlights   Highlight[]
  palaceVerses PalaceVerse[]
  createdAt    DateTime      @default(now()) @map("created_at")

  @@unique([chapterId, verseNum])
  @@index([chapterId])
  @@map("verses")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‚¬ìš©ì & ì¸ì¦ ëª¨ë¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ì‚¬ìš©ì â”€â”€â”€
model User {
  id               Int                  @id @default(autoincrement())
  email            String               @unique @db.VarChar(255)
  name             String?              @db.VarChar(100)
  password         String?              @db.VarChar(255)  // credentials ì¸ì¦ìš© (optional)
  avatarUrl        String?              @map("avatar_url") @db.VarChar(500)
  image            String?              @db.VarChar(500)  // NextAuth í”„ë¡œí•„ ì´ë¯¸ì§€
  emailVerified    DateTime?            @map("email_verified")  // NextAuth ì´ë©”ì¼ ì¸ì¦
  bookmarks        Bookmark[]
  highlights       Highlight[]
  notes            Note[]
  palaces          Palace[]
  attempts         MemorizationAttempt[]
  reviewSchedules  ReviewSchedule[]
  groupMemberships CellGroupMember[]
  badges           UserBadge[]
  accounts         Account[]
  sessions         Session[]
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")

  @@map("users")
}

// â”€â”€â”€ NextAuth: Account â”€â”€â”€
model Account {
  id                String  @id @default(cuid())
  userId            Int     @map("user_id")
  type              String  @db.VarChar(50)
  provider          String  @db.VarChar(50)
  providerAccountId String  @map("provider_account_id") @db.VarChar(255)
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String? @db.VarChar(50)
  scope             String? @db.VarChar(500)
  id_token          String? @db.Text
  session_state     String? @db.VarChar(255)
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

// â”€â”€â”€ NextAuth: Session â”€â”€â”€
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token") @db.VarChar(500)
  userId       Int      @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// â”€â”€â”€ NextAuth: VerificationToken â”€â”€â”€
model VerificationToken {
  identifier String @db.VarChar(255)
  token      String @unique @db.VarChar(500)
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‚¬ìš©ì í™œë™ ëª¨ë¸ (ê¸°ì¡´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ë¶ë§ˆí¬ â”€â”€â”€
model Bookmark {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  verseId   Int      @map("verse_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  verse     Verse    @relation(fields: [verseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, verseId])
  @@index([userId])
  @@index([verseId])
  @@map("bookmarks")
}

// â”€â”€â”€ í•˜ì´ë¼ì´íŠ¸ â”€â”€â”€
model Highlight {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  verseId   Int      @map("verse_id")
  color     String   @default("#FFEB3B") @db.VarChar(20)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  verse     Verse    @relation(fields: [verseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([userId, verseId])
  @@index([userId])
  @@index([verseId])
  @@map("highlights")
}

// â”€â”€â”€ ë…¸íŠ¸/ë©”ëª¨ â”€â”€â”€
model Note {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String?  @db.VarChar(255)
  content   String   @db.Text
  bookRef   String?  @map("book_ref") @db.VarChar(50)  // "ì°½ 1:1" ê°™ì€ ì°¸ì¡°
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("notes")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê¸°ì–µì˜ ê¶ì „ ëª¨ë¸ (Palace)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ê¸°ì–µì˜ ê¶ì „ ì¸ìŠ¤í„´ìŠ¤ â”€â”€â”€
model Palace {
  id              String               @id @default(cuid())
  userId          Int                  @map("user_id")
  name            String               @db.VarChar(200)  // "ì‹œí¸ 23í¸ ê¶ì „"
  verseRef        String               @map("verse_ref") @db.VarChar(100)  // "ì‹œí¸ 23:1-6"
  verseText       String               @map("verse_text") @db.Text
  templateKey     String               @map("template_key") @db.VarChar(50)  // "default_apartment_20"
  narrative       String?              @db.Text  // ì „ì²´ ì›Œí¬ìŠ¤ë£¨ ë‚´ëŸ¬í‹°ë¸Œ
  imageStyle      String               @default("watercolor") @map("image_style") @db.VarChar(30)
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  loci            PalaceLocus[]
  palaceVerses    PalaceVerse[]
  attempts        MemorizationAttempt[]
  reviewSchedules ReviewSchedule[]
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  @@index([userId])
  @@map("palaces")
}

// â”€â”€â”€ ê¶ì „ ë‚´ ê°œë³„ ìœ„ì¹˜(Locus) â”€â”€â”€
model PalaceLocus {
  id               String  @id @default(cuid())
  palaceId         String  @map("palace_id")
  locusIndex       Int     @map("locus_index")  // 0-19
  locusName        String  @map("locus_name") @db.VarChar(50)  // "ì—˜ë¦¬ë² ì´í„°"
  segmentText      String? @map("segment_text") @db.Text  // ë°°ì •ëœ êµ¬ì ˆ ë¶„ì ˆ
  keyword          String? @db.VarChar(100)  // í•µì‹¬ í‚¤ì›Œë“œ
  imageDescription String? @map("image_description") @db.Text  // í•œêµ­ì–´ ì´ë¯¸ì§€ ë¬˜ì‚¬
  imageUrl         String? @map("image_url") @db.VarChar(1000)  // ìƒì„±ëœ ì´ë¯¸ì§€ URL
  imagePrompt      String? @map("image_prompt") @db.Text  // FLUXìš© ì˜ì–´ í”„ë¡¬í”„íŠ¸
  senses           String? @db.Text  // JSON: ì˜¤ê° ë¬˜ì‚¬ ë°°ì—´
  palace           Palace  @relation(fields: [palaceId], references: [id], onDelete: Cascade)

  @@unique([palaceId, locusIndex])
  @@index([palaceId])
  @@map("palace_loci")
}

// â”€â”€â”€ ê¶ì „-ì„±ê²½êµ¬ì ˆ ì—°ê²° â”€â”€â”€
model PalaceVerse {
  id       String @id @default(cuid())
  palaceId String @map("palace_id")
  verseId  Int    @map("verse_id")
  orderNum Int    @map("order_num")  // ê¶ì „ ë‚´ ìˆœì„œ
  palace   Palace @relation(fields: [palaceId], references: [id], onDelete: Cascade)
  verse    Verse  @relation(fields: [verseId], references: [id], onDelete: Cascade)

  @@unique([palaceId, verseId])
  @@index([palaceId])
  @@index([verseId])
  @@map("palace_verses")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë³µìŠµ & í…ŒìŠ¤íŠ¸ ëª¨ë¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ê°„ê²© ë°˜ë³µ ìŠ¤ì¼€ì¤„ (SM-2) â”€â”€â”€
model ReviewSchedule {
  id             String    @id @default(cuid())
  userId         Int       @map("user_id")
  palaceId       String    @map("palace_id")
  difficulty     String    @default("moderate") @db.VarChar(20)
  repetitionNum  Int       @default(0) @map("repetition_num")
  easeFactor     Float     @default(2.5) @map("ease_factor")
  intervalDays   Int       @default(1) @map("interval_days")
  nextReviewAt   DateTime  @map("next_review_at")
  lastReviewedAt DateTime? @map("last_reviewed_at")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  palace         Palace    @relation(fields: [palaceId], references: [id], onDelete: Cascade)

  @@unique([userId, palaceId])
  @@index([userId, nextReviewAt])
  @@map("review_schedules")
}

// â”€â”€â”€ ì•”ì†¡ ì‹œë„ ê¸°ë¡ â”€â”€â”€
model MemorizationAttempt {
  id        String   @id @default(cuid())
  userId    Int      @map("user_id")
  palaceId  String   @map("palace_id")
  userText  String   @map("user_text") @db.Text  // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸
  score     Float    // 0.0 - 1.0
  quality   Int      // SM-2 quality 0-5
  feedback  String?  @db.Text  // í•œêµ­ì–´ í”¼ë“œë°±
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  palace    Palace   @relation(fields: [palaceId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, palaceId])
  @@index([userId, createdAt])
  @@map("memorization_attempts")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì…€ ê·¸ë£¹ ëª¨ë¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ì…€ ê·¸ë£¹ (êµ¬ì—­ ì˜ˆë°°/ì…€ ëª¨ì„) â”€â”€â”€
model CellGroup {
  id          String            @id @default(cuid())
  name        String            @db.VarChar(200)
  description String?           @db.Text
  inviteCode  String            @unique @map("invite_code") @db.VarChar(20)
  ownerId     Int               @map("owner_id")
  members     CellGroupMember[]
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  @@index([ownerId])
  @@map("cell_groups")
}

// â”€â”€â”€ ì…€ ê·¸ë£¹ ë©¤ë²„ â”€â”€â”€
model CellGroupMember {
  id       String    @id @default(cuid())
  groupId  String    @map("group_id")
  userId   Int       @map("user_id")
  role     String    @default("member") @db.VarChar(20)  // "owner", "leader", "member"
  group    CellGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt DateTime  @default(now()) @map("joined_at")

  @@unique([groupId, userId])
  @@index([userId])
  @@map("cell_group_members")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë°°ì§€ ì‹œìŠ¤í…œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ ë°°ì§€ ì •ì˜ â”€â”€â”€
model Badge {
  id          String      @id @default(cuid())
  name        String      @db.VarChar(100)  // "ì²« ê¶ì „"
  description String      @db.VarChar(500)  // "ì²« ë²ˆì§¸ ê¸°ì–µì˜ ê¶ì „ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤"
  iconEmoji   String      @map("icon_emoji") @db.VarChar(10)  // "ğŸ›ï¸"
  condition   String      @db.VarChar(200)  // "palace_count:1"
  category    String      @default("memorization") @db.VarChar(30)  // ì¹´í…Œê³ ë¦¬
  userBadges  UserBadge[]

  @@map("badges")
}

// â”€â”€â”€ ì‚¬ìš©ì íšë“ ë°°ì§€ â”€â”€â”€
model UserBadge {
  id       String   @id @default(cuid())
  userId   Int      @map("user_id")
  badgeId  String   @map("badge_id")
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  earnedAt DateTime @default(now()) @map("earned_at")

  @@unique([userId, badgeId])
  @@index([userId])
  @@map("user_badges")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Enums
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

enum Testament {
  OLD
  NEW
}
